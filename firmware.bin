#include <ESP8266WiFi.h>
#include <PubSubClient.h>
#include <ESP8266httpUpdate.h>
#include <WiFiClientSecureBearSSL.h>

const char* ssid = "D-Link_DIR-600M";
const char* pass = "gendu#5566";

const char* mqttServer = "broker.hivemq.com";
const char* cmdTopic   = "device/esp12/cmd";
const char* statTopic  = "device/esp12/status";

String otaURL =
"https://raw.githubusercontent.com/gaindlalyadu/ota_test/7ca10c05c487d23321705b9eabe5313362edcfdb/sketch_jan10a.ino.bin";


BearSSL::WiFiClientSecure wifiClient;
PubSubClient mqttClient(wifiClient);

bool otaRequested = false;

void mqttCallback(char* topic, byte* payload, unsigned int length) {
  String msg;
  for (int i = 0; i < length; i++) msg += (char)payload[i];

  if (String(topic) == cmdTopic && msg.startsWith("OTA")) {
    int sep = msg.indexOf('|');
    if (sep > 0) otaURL = msg.substring(sep + 1);
    otaRequested = true;
  }
}

void mqttReconnect() {
  while (!mqttClient.connected()) {
    if (mqttClient.connect("ESP12_NODE")) {
      mqttClient.subscribe(cmdTopic);
    } else {
      delay(2000);
    }
  }
}

void startOTA() {
  mqttClient.publish(statTopic, "OTA_START");

  WiFi.setSleepMode(WIFI_NONE_SLEEP);
  wifiClient.setInsecure();   // GitHub HTTPS

  t_httpUpdate_return ret =
    ESPhttpUpdate.update(wifiClient, otaURL);

  if (ret == HTTP_UPDATE_OK) {
    mqttClient.publish(statTopic, "OTA_OK");
    ESP.restart();
  } else {
    mqttClient.publish(statTopic, "OTA_FAIL");
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("ESP8266 SERIAL OK");
  WiFi.begin(ssid, pass);
  while (WiFi.status() != WL_CONNECTED) delay(500);

  mqttClient.setServer(mqttServer, 1883);
  mqttClient.setCallback(mqttCallback);
}

void loop() {
  if (!mqttClient.connected()) mqttReconnect();
  mqttClient.loop();

  if (otaRequested) {
    otaRequested = false;
    startOTA();   // OTA ONLY here
  }
}
